<figure {{ if isset .Params "class" }}class="{{ index .Params "class" }}"{{ end }}>
  {{ $image := $.Page.Resources.GetMatch (.Get "src") }}
  {{ if isset .Params "link"}}<a href="{{ index .Params "link"}}">{{ end }}
  <img src="{{ $image.RelPermalink }}" alt="{{ $image.Title }}" />
  {{ if isset .Params "link"}}</a>{{ end }}
  {{ if eq (index .Params "with-caption" | default "true") "true" }}<figcaption><h5>{{ $image.Title }}</h5></figcaption>{{end}}
</figure>